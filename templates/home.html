{% extends 'base.html' %}
{% block content %}
<div class="header">
    <div id="state">{{ state }}</div>
    <div id="countdown">0</div>
</div>
<div class="main">
    <div class="outer-margin"></div>
    <div class="team" id="legion">
        <div class="team-header">Legion</div>
        <div class="team-players">
            {% for player in teams[ "legion" ] %}
            <div class="player" id="legion-{{ loop.index0 }}">
                <div class="player-name">{{ player.name }}</div>
                <div class="selected-hero"></div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="inner-margin"></div>
    <div class="heroes">
        {% for stat, stat_name in [ ( "agi", "Agility" ), ( "int", "Intelligence" ), ( "str", "Strength" ) ] %}
        <div class="stat-block" id="{{ stat }}-heroes">
            <div class="hero-list-header">{{ stat_name }}</div>
            <div class="hero-block">
                {% for index in range( 8 ) %}
                <div class="hero" id="{{ stat }}-{{ index }}">
                    <img class="hero-image" src="https://stats.projectkongor.com/images/{{ heroes[ stat ][ index ].icon }}/icon_128.jpg"/>
                    <div class="hero-name">{{ heroes[ stat ][ index ].name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="inner-margin"></div>
    <div class="team" id="hellbourne">
        <div class="team-header">Hellbourne</div>
        <div class="team-players">
            {% for player in teams[ "hellbourne" ] %}
            <div class="player" id="hellbourne-{{ loop.index0 }}">
                <div class="player-name">{{ player.name }}</div>
                <div class="selected-hero"></div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="outer-margin"></div>
</div>
<button id="start-button" onClick="startDraft()">Start Draft</button>
<div class="chat-area">
    <div class="messages">
        <div id="message-log"></div>
        <form id="message-form">
            <input type="text" id="message-input"/>
            <input type="submit" id="message-button" value="Send"/>
        </form>
    </div>
    <div class="players">
        <div class="players-header">Players</div>
        <div id="players-list">
            {% for player in players %}
            <div class="players-list-name" id="player-{{ loop.index0 }}">{{ player.name }}</div>
            {% endfor %}
        </div>
    </div>
</div>

<script type="text/javascript">
    "use strict";

    var socketio = io();

    function onStateChanged( state )
    {
        console.log( "changing state" );
        let stateLabel = document.getElementById( "state" );
        stateLabel.innerHTML = state;
    };
    socketio.on( "state-changed", onStateChanged );

    let timer;
    function onSetTimer( seconds )
    {
        console.log( "setting timer" );
        let countdownLabel = document.getElementById( "countdown" );
        countdownLabel.innerHTML = seconds;
        clearInterval( timer );
        if( seconds == 0 ) return;
        timer = setInterval( () => {
            --seconds;
            countdownLabel.innerHTML = seconds;
            if( seconds == 0 )
                clearInterval( timer );
        }, 1000 );
    };
    socketio.on( "set-timer", onSetTimer );

    function onUpdateHero( data )
    {
        console.log( `updating hero ${ data.stat }-${ data.index }` );
        let heroDiv = document.getElementById( `${ data.stat }-${ data.index }` );
        let nameLabel = heroDiv.getElementsByClassName( "hero-name" )[ 0 ];
        nameLabel.innerHTML = data.hero.name;
        let image = heroDiv.getElementsByClassName( "hero-image" )[ 0 ];
        image.src = `https://stats.projectkongor.com/images/${ data.hero.icon }/icon_128.jpg`;
    };
    socketio.on( "update-hero", onUpdateHero );

    function onAddPlayer( data )
    {
        console.log( "adding player" );
        let players = document.getElementById( "players-list" );
        players.innerHTML += `<div class="players-list-name" id="player-${ data.index }">${ data.player.name }</div>`;
    };
    socketio.on( "add-player", onAddPlayer );

    function onRemovePlayer( index )
    {
        console.log( "removing player" );
        let player = document.getElementById( `player-${ index }` );
        player.remove();
    };
    socketio.on( "remove-player", onRemovePlayer );

    function onUpdatePlayer( data )
    {
        console.log( "updating player" );
        let player = document.getElementById( `player-${ data.index }` );
        player.innerHTML = data.player.name;
    };
    socketio.on( "update-player", onUpdatePlayer );

    function startDraft()
    {
        socketio.emit( "start-draft" );
    };

    function getTimestamp()
    {
        let time = new Date();
        return time.getHours().toString().padStart( 2, "0" )
             + ":"
             + time.getMinutes().toString().padStart( 2, "0" )
             + ":"
             + time.getSeconds().toString().padStart( 2, "0" );
    };

    let messageForm = document.getElementById( "message-form" );
    messageForm.addEventListener( "submit", sendMessage );
    function sendMessage( event )
    {
        event.preventDefault();

        let input = document.getElementById( "message-input" );
        if( input.value == "" ) return;
        socketio.emit( "message", input.value );
        input.value = "";
    };

    function onMessage( message )
    {
        console.log( "message received" );
        let messageLog = document.getElementById( "message-log" );
        messageLog.innerHTML += `
            <div class="message">
                <span class="message-timestamp">${ getTimestamp() }</span>
                <span class="message-message">${ message }</span>
            </div>
        `;
        messageLog.scrollTop = messageLog.scrollHeight;
    };
    socketio.on( "message", onMessage );

    function onSetName( name )
    {
        console.log( "requesting name change" );
        let form = new FormData();
        form.append( "name", name );
        fetch( "name", { method: "POST", body: form } );
    };
    socketio.on( "set-name", onSetName );
</script>
{% endblock %}
